# box-cloudapp-web


------------------------------------
**Version**：1.5.4.21
**修订时间**：2016-11-25
###**新增特性**：Office文档在线编辑
基于金格的iWebOffice2015中间件实现了Office文档的在线编辑后保存为新版本的功能，支持个人空间的文件和团队空间内可以编辑的文件。
###**设计思路**
- 要使用ufm来获取dss的上传地址和下载地址，考虑到ufm基于Session的鉴权方式，故而将在线编辑功能直接内嵌到cloudapp-web模块内完成;
- 金格提供的是基于ActiveX的解决方案，通过ActiveX来调用Office并对外暴露VBA对象供第三方调用;
- 业务流程：
	1. 用户在cloudapp页面上点击“在线编辑”菜单，弹出在线编辑的页面，传递文件ownerId、parentId、fileId等核心参数；
	2. 在线编辑页面，先加载金格的ActiveX控件，并向控件注册OnReady和OnOLECommand以及OnCommand事件；
	3. 控件加载完成后，自动触发OnReady事件方法，发起标准的文件下载流程（调用ufm，拿到dss下载地址，将下载地址传递给控件的Http对象，下载完成后保存到本地并在控件内打开文件开始编辑）；
	4. 用户点击工具栏的“保存”图标，触发OnOLECommand事件方法，方法内调用saveRevision方法执行真正的文件保存与上传操作；
	5. 用户点击菜单栏上的“保存”菜单，触发OnCommand事件方法，方法内调用saveRevision方法执行真正的文件保存与上传操作；
	6. saveRevision方法，首先调用控件自身的WebSaveLocalFile方法将文件保存到本地，然后执行标准的上传流程（调用preUpload，拿到dss上传地址，将上传地址传递给控件的Http对象，将文件添加到Http对象，执行Post上传操作）。
###**使用说明**：
在文件列表的右键菜单上增加了“在线编辑”的按钮，点击后弹出在线编辑的页面编辑文件，编辑完成后，点击工具栏或菜单栏的保存按钮（也可以通过Ctrl+S的保存快捷键触发）即可将文件保存到服务器生成修订版本。
###**存在问题**：
1. 用户频繁点击保存或Ctrl+S会触发许多的上传请求，造成N多版本，这里考虑是后端dss按时间多版本合并；
2. 金格这个中间件的兼容性问题，目前只在 win7 + Office2003 + IE11 的环境下测试成功，可以流畅运行，其他操作系统或Office未做详尽的兼容性测试，已知Chrome38以上版本由于关闭了NPAPI接口导致中间件不可用，win10非administrator账户可能存在权限问题导致不可用。
###**部署说明**：
用户第一次进入在线编辑页面时，默认会自动下载并安装ocx控件（需要用户点击确认），如果没有自动安装的则需要手动安装。

#1.5.4.2 20161222

更新upload.cab 版本号2.1.2.8
此版本在文件夹上传时，里面存在大于2G文件，给出提示，确定后进入上传